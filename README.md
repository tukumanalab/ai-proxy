# AI Proxy

OpenCodeからさくらのAIへのリクエストを中継・モニタリングするプロキシサーバー

## 機能

- リクエストとレスポンスの完全なモニタリング
- リクエストヘッダー、ボディの詳細ログ出力
- レスポンスステータス、ヘッダー、ボディの詳細ログ出力
- 色付きコンソール出力で見やすいログ
- リクエスト処理時間の計測
- **SQLiteデータベースへの全リクエスト保存**
- **Web UIダッシュボードでリクエスト履歴を閲覧**
- **リクエスト詳細ページで完全な情報を表示**
- ページネーション、検索機能付き
- **NGワードフィルター**: 不適切なリクエストを自動ブロック

## セットアップ

### 1. 依存関係のインストール

```bash
npm install
```

### 2. 環境変数の設定

`.env.example`を`.env`にコピーして編集：

```bash
cp .env.example .env
```

`.env`ファイルを編集：

```
PORT=3000
SAKURA_AI_API=https://api.sakura.ai/v1
```

`SAKURA_AI_API`にはさくらのAIの実際のAPIエンドポイントを設定してください。

## 使い方

### 開発モード（TypeScriptを直接実行）

```bash
npm run dev
```

### プロダクションモード

```bash
# ビルド
npm run build

# 実行
npm start
```

### OpenCodeでの設定

OpenCodeの設定で、APIエンドポイントをこのプロキシサーバーのURLに変更します：

```
http://localhost:3000/proxy
```

## デプロイメント

VPSサーバーへのデプロイ方法については、以下のドキュメントを参照してください：

**[VPSデプロイメントガイド](docs/vps-deployment.md)**

nginx環境でのセットアップ、PM2によるプロセス管理、リバースプロキシ設定などを詳しく解説しています。

## Web UIダッシュボード

プロキシサーバーを起動後、ブラウザで以下のURLにアクセス：

```
http://localhost:3000
```

### ダッシュボード機能

- **リクエスト一覧表示**: すべてのリクエストを時系列で表示
- **リクエスト内容プレビュー**: ユーザーメッセージを緑色で強調表示（150文字まで）
- **リアルタイム検索**: パス、メソッド、ステータスで絞り込み
- **ページネーション**: 大量のリクエストも快適に閲覧
- **ステータス表示**: HTTPステータスコード、エラーを視覚的に表示
- **処理時間表示**: 各リクエストの処理時間を確認

### リクエスト詳細ページ

各リクエストをクリックすると詳細ページが表示され、以下の情報を確認できます：

- リクエストヘッダー（コピー可能）
- リクエストボディ（整形されたJSON）
- レスポンスヘッダー（コピー可能）
- レスポンスボディ（整形されたJSON）
- エラー情報（エラーが発生した場合）

## コンソールログ

プロキシサーバーは以下の情報をコンソールに出力します：

### リクエスト情報
- リクエスト番号とタイムスタンプ
- HTTPメソッドとパス
- リクエストヘッダー
- クエリパラメータ
- リクエストボディ（存在する場合）

### レスポンス情報
- レスポンスステータスコードとメッセージ
- レスポンスヘッダー
- レスポンスボディ
- 処理時間（ミリ秒）

### ヘルスチェック

プロキシサーバーが正常に動作しているか確認：

```bash
curl http://localhost:3000/health
```

## データベース

すべてのリクエストは`proxy.db`（SQLite）に保存されます。データベースファイルの場所は`.env`ファイルで変更可能：

```
DB_PATH=./custom-path/proxy.db
```

## NGワードフィルター

リクエストに不適切な単語が含まれている場合、自動的にブロックします。

### NGワードの設定

`.env`ファイルで設定（カンマ区切り、大文字小文字を区別しない）：

```
NG_WORDS=暴力,違法,詐欺,危険
```

### ブロック動作

- NGワードを含むリクエストは**403 Forbidden**で拒否されます
- ブロックされたリクエストもデータベースに記録されます
- ダッシュボードでブロックされたリクエストは**赤色の背景**で表示されます
- ステータス欄に**🚫 BLOCKED**と表示されます
- 詳細ページでブロックされた単語を確認できます

### NGワードの更新

NGワードを変更した場合は、サーバーを再起動してください：

```bash
# Ctrl+Cで停止後、再起動
npm run dev
```

## 技術スタック

- Node.js
- TypeScript
- Express
- http-proxy-middleware
- better-sqlite3 (SQLite database)
- EJS (template engine)
- colors (console output)

## トラブルシューティング

### ポートが既に使用されている

`.env`ファイルで別のポート番号を指定してください：

```
PORT=3001
```

### さくらのAI APIへの接続エラー

`.env`ファイルの`SAKURA_AI_API`が正しいか確認してください。

## ライセンス

MIT
